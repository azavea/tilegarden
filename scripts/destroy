#!/bin/bash

set -e

function usage() {
    echo -n "Usage: $(basename "${0}") ENVIRON
Removes all published resources from AWS for the specified deployment.
Options:
    --help      Display this help text
"
}

function main() {
    ENVIRON=${1}
    echo "WARNING: you are about to destroy all your deployed resources for '${ENVIRON}'!"
    printf "That includes:\n - Associated AWS Lambda functions\n - Associated API Gateways\n - Associated IAM roles (if automatically generated)\n - Associated CloudFront distributions\n"
    read -p "If this is what you want, type 'yes' to continue: " -r
    echo
    if [[ $REPLY =~ ^[yY][eE][sS]$ ]]
    then
        # Destroy deployed resources
        # If any part of this fails, the parts that didn't fail
        # remain destroyed, so it's best to just carry on and
        # follow through.
        docker-compose --env-file ".env.${ENVIRON}" run --rm --no-deps \
            tiler yarn destroy || true
        docker-compose --env-file ".env.${ENVIRON}" run --rm \
            -e TF_VAR_source_id=$(<src/tiler/.api-id-${ENVIRON}) \
            terraform destroy -auto-approve

        # Remove local config files
        docker-compose run --rm --no-deps tiler \
            rm claudia/claudia-${ENVIRON}.json .api-id-${ENVIRON}
        docker-compose run --rm --entrypoint rm terraform \
            -rf .terraform "${PROJECT_NAME}-${USER}-${ENVIRON}.tfstate*"
    else
        echo "Aborting destroy"
    fi
}

if [ "${BASH_SOURCE[0]}" = "${0}" ]
then
    if [ "${1:-}" = "--help" ] || [ -z "${1}" ]; then
        usage
    else
        main ${1}
    fi
    exit
fi
